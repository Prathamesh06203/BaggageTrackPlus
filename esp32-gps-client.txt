#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <TinyGPS++.h>

// WiFi credentials
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// Server endpoint
const char* serverUrl = "http://your-server:5000/api/location";

// GPS Module connection - Using Hardware Serial2
#define GPS_RX 34  // GPS TX connects to ESP32 RX
#define GPS_TX 12  // GPS RX connects to ESP32 TX

TinyGPSPlus gps;  // GPS parser object
HardwareSerial GPSSerial(1);  // Use UART1

void setup() {
    Serial.begin(115200);
    
    // Initialize GPS
    GPSSerial.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);
    
    // Connect to WiFi
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("\nWiFi connected");
}

void sendLocationData(double latitude, double longitude) {
    if (WiFi.status() == WL_CONNECTED) {
        HTTPClient http;
        
        // Create JSON document
        StaticJsonDocument<200> doc;
        doc["latitude"] = latitude;
        doc["longitude"] = longitude;
        doc["timestamp"] = millis();
        doc["device_id"] = "TTGO-01";  // Unique identifier for your device
        
        String jsonString;
        serializeJson(doc, jsonString);
        
        // Send POST request
        http.begin(serverUrl);
        http.addHeader("Content-Type", "application/json");
        
        int httpResponseCode = http.POST(jsonString);
        
        if (httpResponseCode > 0) {
            Serial.printf("HTTP Response code: %d\n", httpResponseCode);
        } else {
            Serial.printf("Error code: %d\n", httpResponseCode);
        }
        
        http.end();
    }
}

void loop() {
    // Read GPS data
    while (GPSSerial.available() > 0) {
        if (gps.encode(GPSSerial.read())) {
            if (gps.location.isValid()) {
                double latitude = gps.location.lat();
                double longitude = gps.location.lng();
                
                Serial.print("Latitude: ");
                Serial.println(latitude, 6);
                Serial.print("Longitude: ");
                Serial.println(longitude, 6);
                
                sendLocationData(latitude, longitude);
            }
        }
    }
    
    // Small delay to prevent overwhelming the server
    delay(1000);
}
